name: Build and Auto-Release eBook

on:
  push:
    branches:
      - main

permissions:
  contents: write

jobs:
  build-and-release:
    runs-on: ubuntu-latest

    steps:
    - name: ðŸ“¥ Checkout repository
      uses: actions/checkout@v3
      with:
        fetch-depth: 0

    - name: ðŸ§° Set up Pandoc
      uses: r-lib/actions/setup-pandoc@v2

    - name: ðŸ“¦ Install LaTeX
      run: |
        sudo apt-get update
        sudo apt-get install -y texlive-xetex \
                                texlive-fonts-recommended \
                                texlive-plain-generic \
                                texlive-latex-extra \
                                fonts-dejavu

    - name: ðŸ”¢ Auto-version minor if new .md added, else patch
      id: compute_tag
      run: |
        LATEST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "v0.1.0")
        VERSION=${LATEST_TAG#v}
        IFS='.' read -r MAJOR MINOR PATCH <<< "$VERSION"

        CHANGED=$(git diff --name-status "$LATEST_TAG"..HEAD | grep '\.md$' || true)
        ADDED=$(echo "$CHANGED" | grep '^A' || true)

        if [[ -n "$ADDED" ]]; then
          NEW_MINOR=$((MINOR + 1))
          NEW_PATCH=0
          BUMP_TYPE="minor"
        else
          NEW_MINOR=$MINOR
          NEW_PATCH=$((PATCH + 1))
          BUMP_TYPE="patch"
        fi

        NEW_TAG="v$MAJOR.$NEW_MINOR.$NEW_PATCH"
        echo "ðŸ“Œ Bumping $BUMP_TYPE version â†’ $NEW_TAG"
        echo "tag=$NEW_TAG" >> $GITHUB_OUTPUT
        echo "bump_type=$BUMP_TYPE" >> $GITHUB_OUTPUT

    - name: ðŸ· Set version and date environment variables
      run: |
        echo "VERSION=${{ steps.compute_tag.outputs.tag }}" >> $GITHUB_ENV
        echo "DATE=$(date +%Y-%m-%d)" >> $GITHUB_ENV

    - name: ðŸ›  Inject version and date into metadata.yaml
      run: |
        sed -i.bak "s/__VERSION__/${{ env.VERSION }}/g" metadata.yaml
        sed -i.bak "s/__DATE__/${{ env.DATE }}/g" metadata.yaml

    - name: ðŸ“š Build eBook formats
      run: |
        mkdir -p output

        FILEBASE="Secure-Bash-for-macOS-${{ env.VERSION }}"

        # Common chapter ordering
        CHAPTERS="$(find ebook/about.md) \
                   $(find ebook/part1_bash_fundamentals -name '*.md' | sort) \
                   $(find ebook/part2_advanced_security -name '*.md' | sort) \
                   $(find ebook/part3_real_world_projects -name '*.md' | sort) \
                   $(find ebook/appendices -name '*.md' | sort)"

        # PDF
        pandoc $CHAPTERS \
          --metadata-file=metadata.yaml \
          --template=templates/eisvogel.latex \
          -o output/${FILEBASE}.pdf

        # EPUB
        pandoc $CHAPTERS \
          --metadata-file=metadata.yaml \
          --css=templates/ebook-style.css \
          --toc --toc-depth=2 \
          --highlight-style=breezeDark \
          -o output/${FILEBASE}.epub

        # HTML
        pandoc $CHAPTERS \
          --metadata-file=metadata.yaml \
          --css=templates/ebook-style.css \
          --toc --toc-depth=2 \
          --standalone \
          --highlight-style=breezeDark \
          -o output/${FILEBASE}.html

    - name: ðŸ§¹ Clean up backup file
      run: rm metadata.yaml.bak

    - name: ðŸ“¦ Create GitHub Release
      uses: softprops/action-gh-release@v2
      with:
        tag_name: ${{ steps.compute_tag.outputs.tag }}
        name: "Release ${{ steps.compute_tag.outputs.tag }} (${{ steps.compute_tag.outputs.bump_type }})"
        prerelease: true
        generate_release_notes: true
        files: |
          output/Secure-Bash-for-macOS-${{ env.VERSION }}.pdf
          output/Secure-Bash-for-macOS-${{ env.VERSION }}.epub
          output/Secure-Bash-for-macOS-${{ env.VERSION }}.html
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}