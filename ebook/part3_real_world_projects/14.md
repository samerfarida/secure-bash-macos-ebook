# Chapter 14: Automated Hardening & Compliance (mSCP)

## Learning Objectives

By the end of this chapter, you will be able to:

1. Explain what the macOS Security Compliance Project (mSCP) is and what it generates (guidance, compliance scripts, configuration profiles, and DDM components).
1. Select an mSCP baseline aligned to your framework (for example, NIST 800‑53r5, CIS, or DISA STIG) and tailor it for your organization.
1. Generate compliance scripts and configuration profiles, and understand where enforcement must be done by MDM/DDM versus shell scripts.
1. Schedule automated audits, emit machine‑readable results (JSON/CSV), and map findings back to control IDs for dashboards or SIEM.
1. Build a minimal Bash‑first verifier that complements mSCP outputs for custom checks, drift detection, and rollup reporting.

## Introduction

The macOS Security Compliance Project (mSCP) is an open‑source, community‑led effort that turns security guidance into programmatically generated outputs for macOS. From a single, versioned source of truth, you can produce documentation, compliance scripts (check/fix), configuration profiles, and Declarative Device Management (DDM) components for MDM deployment.

> **Production note: MDM vs. scripts**  
> PPPC/TCC, Full Disk Access, and most hardening settings must be applied by MDM/DDM using configuration profiles or declarations. Use scripts primarily to verify and to handle edge‑case remediation.

This chapter is hands‑on: we will generate mSCP outputs, wire up a recurring audit, and publish results in formats your security team can consume.

## 14.1 mSCP at a Glance

- **Baselines:** Curated sets of rules mapped to frameworks such as NIST 800‑53, 800‑171, DISA STIG, and CIS.
- **Outputs:**
  - **Compliance script** (`*_compliance.sh`) with check/fix/check (`--cfc`) support that writes results to a managed plist and log. Note: the generated compliance script expects **zsh**, not bash.
  - **Configuration profiles** (`.mobileconfig`) for MDM deployment, optionally signed.
  - **DDM components** (activations, assets, configurations) for DDM‑aware MDMs.
  - **Mappings/SCAP/Docs** for audits and reporting.

### 14.1.1 Choosing the Right Branch

Always use the branch that matches your target macOS version. Do not build from `main` unless you are developing.

## 14.2 Generate Outputs from mSCP

**Prerequisites:** Python 3, `git`, and a working toolchain for your build host. You do not need Xcode for generation. For signing configuration profiles, you need an appropriate certificate installed in your keychain.

Clone the repository and change into it:

```bash
git clone https://github.com/usnistgov/macos_security.git
cd macos_security
```

### 14.2.1 Generate a Compliance Script

The generator produces a baseline‑specific compliance script and an audit plist. Run with `-s` against a baseline YAML:

```bash
./scripts/generate_guidance.py -s baselines/800-53r5_moderate.yaml
```

What you get (example; your baseline name will differ):

```
build/800-53r5_moderate/800-53r5_moderate_compliance.sh
build/800-53r5_moderate/preferences/org.800-53r5_moderate.audit.plist
build/800-53r5_moderate/*.html
build/800-53r5_moderate/*.pdf
```

The compliance script supports interactive mode or flags like `--check`, `--fix`, and `--cfc` (check‑fix‑check). Results are written to the audit plist and baseline log under `/Library/Logs/`.

**Shell note:** The generated compliance script expects `zsh`. From Bash, invoke:  
`zsh build/<baseline>/<baseline>_compliance.sh --check`

### 14.2.2 Generate Configuration Profiles

For MDM enforcement, generate profiles (unsigned or signed). Use `-p` and point to your baseline:

```bash
# Unsigned
./scripts/generate_guidance.py -p build/baselines/800-53r5_moderate.yaml

# Signed (Subject Key ID required)
./scripts/generate_guidance.py -p -H <SUBJECT_KEY_ID> build/baselines/800-53r5_moderate.yaml
```

Refer to the project documentation for how to retrieve the Subject Key ID when signing.

### 14.2.3 Generate DDM Components (optional but recommended)

If your MDM supports Declarative Device Management, you can generate activations, assets, and configurations directly from the baseline:

```bash
./scripts/generate_guidance.py -D baselines/all_rules.yaml -p -s
```

This builds DDM component JSON (activations, assets, configurations) under `build/<BASELINE>/...`

**Why DDM?** Devices evaluate predicates locally and self‑remediate faster, reducing server traffic and configuration drift.

### 14.2.4 Map Your Internal Controls

If your organization uses an internal framework, `generate_mapping.py` lets you CSV‑map to supported frameworks and produce custom baselines.

```bash
./scripts/generate_mapping.py ~/Desktop/your-mapping.csv
```

## 14.3 Operating Model: MDM/DDM Enforce, Scripts Verify

### 14.3.1 What must come from MDM/DDM

- **PPPC/TCC and Full Disk Access** (privacy permissions) must be delivered via profile or declarations. Scripts cannot grant these.
- **System policies** (Firewall, Gatekeeper, password policy, login window restrictions, and similar) should be applied by MDM/DDM for durability.

### 14.3.2 Where scripts shine

- **Verification:** Emit machine‑readable pass/fail for SIEM and dashboards.
- **Edge remediation:** Handle mis‑tuned or legacy hosts while you fix policy.
- **Contextual checks:** Validate organization‑specific requirements not in a baseline.

## 14.4 Scheduling Audits with launchd

Use a LaunchDaemon to run the baseline’s compliance script (or your own verifier) on a schedule. The following example runs a silent check‑fix‑check daily at 02:00.

```xml
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
<plist version="1.0">
<dict>
  <key>Label</key><string>com.acme.mscp.daily</string>
  <key>ProgramArguments</key>
  <array>
    <string>/bin/zsh</string>
    <string>/Library/Security/mSCP/800-53r5_moderate_compliance.sh</string>
    <string>--cfc</string>
    <string>--quiet=2</string>
  </array>
  <key>StartCalendarInterval</key>
  <dict><key>Hour</key><integer>2</integer><key>Minute</key><integer>0</integer></dict>
  <key>RunAtLoad</key><true/>
  <key>StandardOutPath</key><string>/Library/Logs/mscp_compliance.out</string>
  <key>StandardErrorPath</key><string>/Library/Logs/mscp_compliance.err</string>
</dict>
</plist>
```

Install and load:

```bash
sudo install -m 0644 com.acme.mscp.daily.plist /Library/LaunchDaemons/
sudo launchctl bootstrap system /Library/LaunchDaemons/com.acme.mscp.daily.plist
sudo launchctl enable system/com.acme.mscp.daily
sudo launchctl start system/com.acme.mscp.daily
```

**Tip:** Keep the generated compliance script under a managed path (for example, `/Library/Security/mSCP/`) and refresh it when you update baselines.

## 14.5 A Minimal Bash Verifier (complement to mSCP)

mSCP’s generated compliance script is comprehensive, but sometimes you want a small Bash‑first verifier for quick signals in JAMF extension attributes, Munki conditions, or a cron‑style check. The example below checks common controls and emits compact JSON you can ship to your SIEM.

### 14.5.1 The Verifier Script

```bash
#!/usr/bin/env bash
# file: /usr/local/bin/mscp-mini-audit.sh
# Purpose: quick, read-only compliance checks -> JSON rollup
# Compatible with macOS bash 3.2 (no associative arrays)

set -euo pipefail

# Helpers
json_escape() { python - <<'PY' "$1"; import json,sys; print(json.dumps(sys.argv[1])); PY; }

now_epoch="$(date -u +%s)"
host="$(scutil --get ComputerName 2>/dev/null || hostname)"

pass() { printf '{"control_id":"%s","result":"pass"}
' "$1"; }
fail() { printf '{"control_id":"%s","result":"fail","details":%s}
' "$1" "$(json_escape "$2")"; }

# Checks (read-only; enforcement via MDM/DDM)
check_gatekeeper() {
  local status
  status="$(/usr/sbin/spctl --status 2>/dev/null || true)"
  if [[ "$status" == "assessments enabled" ]]; then pass "os_gatekeeper_enable"; else fail "os_gatekeeper_enable" "$status"; fi
}

check_firewall() {
  # 1 = enabled, 0 = disabled
  local s; s="$(/usr/libexec/ApplicationFirewall/socketfilterfw --getglobalstate 2>/dev/null | awk '{print $NF}')" || true
  if [[ "$s" == "enabled" || "$s" == "1" ]]; then pass "os_firewall_enable"; else fail "os_firewall_enable" "socketfilterfw=$s"; fi
}

check_filevault() {
  local s; s="$(/usr/bin/fdesetup status 2>/dev/null)" || true
  if echo "$s" | grep -qi "FileVault is On"; then pass "os_filevault_enable"; else fail "os_filevault_enable" "$s"; fi
}

check_password_policy() {
  # Example: minimum length >= 12 (organization choice)
  local len; len="$(/usr/bin/pwpolicy getaccountpolicies 2>/dev/null | awk -F'minLength' 'NF>1{print $2}' | tr -dc '0-9' | head -1)"
  if [[ -n "$len" && "$len" -ge 12 ]]; then pass "pw_policy_min_length"; else fail "pw_policy_min_length" "minLength=${len:-unset}"; fi
}

run_all() {
  check_gatekeeper
  check_firewall
  check_filevault
  check_password_policy
}

# Emit JSON array
{
  echo '{'
  printf '"host":%s,' "$(json_escape "$host")"
  printf '"timestamp":%s,' "$now_epoch"
  echo '"results":['
  run_all | paste -sd, -
  echo ']}'
}
```

- Control IDs such as `os_gatekeeper_enable` mirror common mSCP naming so you can correlate results.
- The script only reads state; use MDM profiles or DDM declarations to enforce.

### 14.5.2 Shipping Results

A simple, generic shipper using `curl` to a webhook (change URL and headers to fit your stack):

```bash
#!/usr/bin/env bash
set -euo pipefail
payload="$(/usr/local/bin/mscp-mini-audit.sh)"
curl -sS -X POST https://siem.example.com/intake   -H 'Content-Type: application/json'   --data-binary "$payload" -o /dev/null
```

## 14.6 Tailoring and Exemptions

mSCP supports tailoring (choosing rules) and exemptions (documenting exceptions with reasons), tracked in the audit plist and logs. Use tailoring to align with business risk, then capture exemptions with justification so you remain auditable.

## 14.7 User Experience: Prompting and Guidance

When hardening requires user action (for example, reboots, login/logout, or deferrals), pair enforcement with clear messaging:

- **swiftDialog** for pre/post prompts, progress, or “this will reboot” warnings.
- **Nudge** for user‑friendly OS‑update nudging once you have set deadlines via MDM/DDM.

Example: lightweight pre‑check prompt before a remediation window with swiftDialog:

```bash
#!/usr/bin/env bash
dialog --title "Compliance Window"   --message "Your Mac will run a security compliance check. Save work now."   --button1text "OK"
```

## 14.8 Reporting and Dashboards

- mSCP compliance script stats: use `--stats`, `--compliant`, and `--non_compliant` to summarize the last run.
- SIEM: ingest your JSON from section 14.5 and join to device identity.
- Executive views: map counts back to framework IDs (for example, 800‑53 AC‑2). If you used `generate_mapping.py`, you already have the translation CSV.

## 14.9 Troubleshooting

- **Wrong branch:** If output or rule coverage looks off, verify you are on the OS‑matched branch.
- **Profiles not taking effect:** Confirm MDM scope and conflicts. PPPC/TCC require supervision and managed profiles.
- **Compliance script shell:** If you see syntax errors in Bash, run with `zsh` as required.
- **DDM not applying:** Ensure your MDM supports DDM on the target OS and you delivered the correct activations, assets, and configurations.

## macOS Tips

- **Bash 3.2 vs 5:** If you author your own verifiers, stick to Bash 3.2‑compatible syntax (ships with macOS) unless you deploy a Bash 5 runtime.
- **Apple silicon paths:** If you reference Homebrew tools in checks, use `/opt/homebrew` on Apple silicon.
- **Managed preferences:** Many profile‑applied settings surface in `/Library/Managed Preferences/` as plists you can read with `plutil -p` (read‑only for verification).

## Chapter 14 Exercise

**Build a compliance pipeline:**

1. Generate a compliance script for your chosen baseline and run `--check` and `--cfc`.
1. Generate configuration profiles for the same baseline and scope them via your MDM.
1. Create a LaunchDaemon to run nightly and ship the audit plist/log summary to your SIEM.
1. Add your mini‑audit JSON to the SIEM and build a simple dashboard showing pass/fail by control ID.

## References

- mSCP introduction and documentation: https://pages.nist.gov/macos_security/welcome/introduction/
- mSCP source repository: https://github.com/usnistgov/macos_security
- Apple Platform Security (PPPC/TCC, profiles, and related topics): https://support.apple.com/guide/security/welcome/web
- Declarative Device Management overview: https://developer.apple.com/documentation/devicemanagement